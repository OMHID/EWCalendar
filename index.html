<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Empire Wind Team Schedule</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      text-align: center;
    }
    .calendar-container {
      overflow-x: auto;
      border: 1px solid #ccc;
      max-height: 90vh;
      margin-bottom: 20px;
      position: relative;
    }
    .calendar-grid {
      border-collapse: collapse;
      width: max-content;
      min-width: 100%;
      margin: 0 auto;
    }
    .calendar-grid th, .calendar-grid td {
      border: 1px solid #ddd;
      padding: 1px;
      text-align: center;
      white-space: nowrap;
      font-size: 10px;
      background: #fff;
    }
    .employee-name {
      position: sticky;
      left: 0;
      background: #fff;
      z-index: 2;
      font-weight: bold;
      min-width: 160px;
      max-width: 160px;
      text-align: left;
      padding-left: 5px;
      font-size: 12px !important;
      white-space: nowrap;
    }
    .calendar-grid th.day, .calendar-grid td.day {
      width: 22px;
      min-width: 22px;
      max-width: 22px;
    }
    .weekend { background-color: #f0f0f0 !important; }
    .month-blue { background-color: #e6f2ff !important; }
    .month-green { background-color: #e6ffe6 !important; }
    .spacer-row td {
      height: 5px;
      background: #fff;
      border: none;
      padding: 0;
      margin: 0;
    }
    .month-header { font-size: 14px !important; padding: 10px 0; height: 20px; vertical-align: middle; }
    .red-team { color: red; }
    .blue-team { color: darkblue; }
    .no-team { color: black; }
  </style>
</head>
<body>

<h2>Empire Wind Team Schedule</h2>
<div class="calendar-container">
  <table class="calendar-grid">
    <thead id="calendar-head"></thead>
    <tbody id="calendar-body"></tbody>
  </table>
</div>

<script>
  const client = supabase.createClient(
    'https://gxornxzzkmrkrenaszoq.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd4b3JueHp6a21ya3JlbmFzem9xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYxMjM2NjIsImV4cCI6MjA2MTY5OTY2Mn0.-fc15M3MznSnEGW9CnD2gZZe7L0Vsd9vag_W-0lCPeA'
  );

  const head = document.getElementById('calendar-head');
  const body = document.getElementById('calendar-body');
  const monthColors = ['month-blue', 'month-green'];

  const startDate = new Date(localStorage.getItem('calendarStart') || '2025-04-01');
  const endDate = new Date(localStorage.getItem('calendarEnd') || '2029-01-01');
  const dates = [];
  let d = new Date(startDate);
  while (d <= endDate) {
    dates.push(new Date(d));
    d.setDate(d.getDate() + 1);
  }

  let techs = [];
  let activities = [];
  let teams = {};

  async function loadData() {
    const { data: techData, error: techError } = await client.from('technicians').select('*').eq('active', true).order('name');
    const { data: activityData, error: activityError } = await supabase.from('activities').select('*');
    const { data: teamData, error: teamError } = await supabase.from('teams').select('*');

    if (techError || activityError || teamError) {
      alert("Error loading data.");
      console.error({ techError, activityError, teamError });
      return;
    }

    techs = techData;
    activities = activityData;
    teamData.forEach(({ technician_name, team }) => {
      teams[technician_name] = team;
    });

    renderCalendar();
  }

  function renderCalendar() {
    // Month row
    const monthRow = document.createElement('tr');
    const emptyMonthTh = document.createElement('th');
    emptyMonthTh.className = 'employee-name';
    monthRow.appendChild(emptyMonthTh);
    let lastMonth = '', monthCell = null, monthSpan = 0, monthColorIndex = 0;

    dates.forEach((date, i) => {
      const label = `${date.toLocaleString('default', { month: 'long' })} - ${date.getFullYear()}`;
      if (label !== lastMonth) {
        if (monthCell) {
          monthCell.colSpan = monthSpan;
          monthCell.classList.add(monthColors[monthColorIndex++ % 2], 'month-header');
        }
        monthCell = document.createElement('th');
        monthCell.textContent = label;
        monthRow.appendChild(monthCell);
        monthSpan = 1;
        lastMonth = label;
      } else {
        monthSpan++;
      }
      if (i === dates.length - 1 && monthCell) {
        monthCell.colSpan = monthSpan;
        monthCell.classList.add(monthColors[monthColorIndex % 2], 'month-header');
      }
    });
    head.appendChild(monthRow);

    // Date and weekday rows
    ['Name', ''].forEach((label, i) => {
      const row = document.createElement('tr');
      const th = document.createElement('th');
      th.className = 'employee-name';
      th.textContent = i === 0 ? 'Name' : '';
      row.appendChild(th);
      dates.forEach(date => {
        const th = document.createElement('th');
        th.className = 'day';
        if (i === 0) th.textContent = date.getDate();
        else th.textContent = date.toLocaleDateString('en-US', { weekday: 'short' })[0];
        if (date.getDay() === 0 || date.getDay() === 6) th.classList.add('weekend');
        row.appendChild(th);
      });
      head.appendChild(row);
    });

    // Tech rows
    const techRowMap = {};
    techs.forEach(({ name }) => {
      const tr = document.createElement('tr');
      const nameCell = document.createElement('td');
      nameCell.className = 'employee-name';
      nameCell.textContent = name;
      nameCell.classList.add(teams[name] === 'Red' ? 'red-team' : teams[name] === 'Blue' ? 'blue-team' : 'no-team');
      tr.appendChild(nameCell);

      dates.forEach(date => {
        const td = document.createElement('td');
        td.className = 'day';
        td.dataset.date = date.toISOString().split('T')[0];
        if (date.getDay() === 0 || date.getDay() === 6) td.classList.add('weekend');
        tr.appendChild(td);
      });

      body.appendChild(tr);
      techRowMap[name] = tr;
    });

    // Render activities
    activities.forEach(({ tech, start_date, end_date, status, type, location, project_name, notes }) => {
      const s = new Date(start_date);
      const e = new Date(end_date);
      if (techRowMap[tech]) {
        const cells = techRowMap[tech].querySelectorAll('td.day');
        dates.forEach((d, i) => {
          if (d >= s && d <= e) {
            const cell = cells[i];
            cell.style.backgroundColor =
              ["Training", "Standby"].includes(status) ? 'orange' :
              ["PTO", "LOA", "Medical", "Field Break (15x15)"].includes(status) ? 'red' : '#4CAF50';
            cell.title = `Status: ${status}\nType: ${type}\nLocation: ${location}\nProject: ${project_name}\nNotes: ${notes}`;
          }
        });
      }
    });
  }

  window.onload = () => {
    loadData();
  };

</script>
</body>
</html>
