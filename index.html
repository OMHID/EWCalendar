<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Empire Wind Team Schedule — View Only</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; text-align: center; }
    .calendar-container { overflow-x: auto; border: 1px solid #ccc; max-height: 90vh; margin-bottom: 20px; position: relative; }
    .calendar-grid { border-collapse: collapse; width: max-content; min-width: 100%; margin: 0 auto; }
    .calendar-grid th, .calendar-grid td { border: 1px solid #ddd; padding: 1px; text-align: center; white-space: nowrap; font-size: 10px; background: #fff; }
    .employee-name { position: sticky; left: 0; background: #fff; z-index: 2; font-weight: bold; min-width: 160px; max-width: 160px; text-align: left; padding-left: 5px; font-size: 12px !important; white-space: nowrap; }
    .calendar-grid th.day, .calendar-grid td.day { width: 50px; min-width: 50px; max-width: 50px; }
    .weekend { background-color: #f0f0f0 !important; }
    .month-blue { background-color: #e6f2ff !important; }
    .month-green { background-color: #e6ffe6 !important; }
    .spacer-row td { height: 5px; background: #fff; border: none; padding: 0; margin: 0; }
    .month-header { font-size: 14px !important; padding: 10px 0; height: 20px; vertical-align: middle; }

    /* Team name cell colors */
    .red-team  { background-color: #d9534f !important; color: white !important; }
    .blue-team { background-color: #337ab7 !important; color: white !important; }
    .no-team   { background-color: #444   !important; color: white !important; }

    /* View-only range button */
    .toolbar { margin: 10px 0 20px; }
    .toolbar button {
      padding: 8px 12px; font-size: 14px; border: none; border-radius: 6px;
      background: #0d6efd; color: #fff; cursor: pointer;
    }
    .toolbar button:hover { background: #0b5ed7; }

    /* Minimal modal just for date range */
    #rangeModal {
      display: none; position: fixed; z-index: 2000; inset: 0;
      background: rgba(0,0,0,0.4);
    }
    #rangeModal .modal-content {
      background: #fff; width: 320px; margin: 10% auto; padding: 16px;
      border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); text-align: left;
    }
    #rangeModal label { font-weight: bold; display: block; margin-top: 8px; }
    #rangeModal input[type="date"] { width: 100%; padding: 6px; margin-top: 4px; box-sizing: border-box; }
    #rangeModal .footer { text-align: right; margin-top: 14px; }
    #rangeModal .footer button {
      padding: 6px 10px; margin-left: 8px; border: none; border-radius: 6px; cursor: pointer;
    }
    #rangeModal .footer .cancel { background: #6c757d; color:#fff; }
    #rangeModal .footer .save { background: #198754; color:#fff; }
    #rangeModal .footer .cancel:hover { background:#5c636a; }
    #rangeModal .footer .save:hover { background:#157347; }
    small.muted { color:#666; display:block; margin-top:6px; }
  </style>
</head>
<body>

<h2>Empire Wind Team Schedule</h2>

<!-- View-only toolbar: local calendar range -->
<div class="toolbar">
  <button id="openRange">Set calendar range</button>
  <small class="muted">Updates only your view</small>
</div>

<div class="calendar-container">
  <table class="calendar-grid" id="calendar">
    <thead id="calendar-head"></thead>
    <tbody id="calendar-body"></tbody>
  </table>
</div>

<!-- Minimal date-range modal (view-only, localStorage only) -->
<div id="rangeModal">
  <div class="modal-content">
    <h3 style="margin-top:0;">Set Calendar Range</h3>
    <label for="rangeStart">Start Date</label>
    <input type="date" id="rangeStart">
    <label for="rangeEnd" style="margin-top:10px;">End Date</label>
    <input type="date" id="rangeEnd">
    <small class="muted">These dates are saved only on your device.</small>
    <div class="footer">
      <button class="cancel" id="cancelRange">Cancel</button>
      <button class="save" id="saveRange">Save</button>
    </div>
  </div>
</div>

<!-- No other buttons, no context menu, no modals beyond range picker -->

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
  const client = supabase.createClient(
    'https://gxornxzzkmrkrenaszoq.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd4b3JueHp6a21ya3JlbmFzem9xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYxMjM2NjIsImV4cCI6MjA2MTY5OTY2Mn0.-fc15M3MznSnEGW9CnD2gZZe7L0Vsd9vag_W-0lCPeA'
  );

  function parseLocalDate(str) {
    const [y,m,d] = str.split('-').map(Number);
    return new Date(y, m - 1, d);
  }

  // Defaults used if a viewer hasn’t set their own range yet
  const startDate = parseLocalDate(localStorage.getItem('calendarStart') || '2025-05-15');
  const rawEnd    = localStorage.getItem('calendarEnd') || '2026-03-31';
  const endDate   = parseLocalDate(rawEnd);

  const dates = [];
  let date = new Date(startDate);
  while (date <= endDate) {
    dates.push(new Date(date));
    date.setDate(date.getDate() + 1);
  }

  async function loadTechsFromSupabase(includeInactive = false) {
    const q = client.from('techs').select('*').order('name');
    if (!includeInactive) q.eq('active', true);
    const { data, error } = await q;
    if (error) { console.error(error); return []; }
    return data;
  }

  // Fetch ALL activities with pagination
  async function loadActivitiesFromSupabase() {
    const pageSize = 1000;
    let from = 0;
    let all = [];
    while (true) {
      const { data, error } = await client
        .from('activities')
        .select('*')
        .order('start_date', { ascending: true })
        .range(from, from + pageSize - 1);
      if (error) { console.error(error); return all; }
      if (!data || data.length === 0) break;
      all = all.concat(data);
      if (data.length < pageSize) break;
      from += pageSize;
    }
    return all;
  }

  const head = document.getElementById('calendar-head');
  const body = document.getElementById('calendar-body');
  let techs = [], activities = [];

  async function init() {
    techs = await loadTechsFromSupabase();
    activities = await loadActivitiesFromSupabase();
    render();
    wireRangeModal();
  }
  init();

  const monthColors = ['month-blue', 'month-green'];

  // Month headers
  const monthRow = document.createElement('tr');
  const emptyMonthTh = document.createElement('th');
  emptyMonthTh.className = 'employee-name';
  monthRow.appendChild(emptyMonthTh);

  let lastMonth = '', monthCell = null, monthSpan = 0, monthColorIndex = 0;
  dates.forEach((d, i) => {
    const label = `${d.toLocaleString('default', { month: 'long' })} - ${d.getFullYear()}`;
    if (label !== lastMonth) {
      if (monthCell) {
        monthCell.colSpan = monthSpan;
        monthCell.classList.add(monthColors[monthColorIndex++ % 2], 'month-header');
      }
      monthCell = document.createElement('th');
      monthCell.textContent = label;
      monthRow.appendChild(monthCell);
      monthSpan = 1;
      lastMonth = label;
    } else {
      monthSpan++;
    }
    if (i === dates.length - 1 && monthCell) {
      monthCell.colSpan = monthSpan;
      monthCell.classList.add(monthColors[monthColorIndex % 2], 'month-header');
    }
  });
  head.appendChild(monthRow);

  // Day + weekday headers (e.g., 4-Nov and W)
  ['Name', ''].forEach((_, i) => {
    const row = document.createElement('tr');
    const th = document.createElement('th');
    th.className = 'employee-name';
    th.textContent = i === 0 ? 'Name' : '';
    row.appendChild(th);

    dates.forEach(d => {
      const h = document.createElement('th');
      h.className = 'day';
      if (i === 0) h.textContent = d.toLocaleDateString('en-US', { day: 'numeric', month: 'short' });
      else        h.textContent = d.toLocaleDateString('en-US', { weekday: 'short' })[0];
      if (d.getDay() === 0 || d.getDay() === 6) h.classList.add('weekend');
      row.appendChild(h);
    });

    head.appendChild(row);
  });

  // Spacer row
  const spacerRow = document.createElement('tr');
  spacerRow.className = 'spacer-row';
  const spacerNameCell = document.createElement('td');
  spacerNameCell.className = 'employee-name';
  spacerRow.appendChild(spacerNameCell);
  dates.forEach(() => spacerRow.appendChild(document.createElement('td')));
  body.appendChild(spacerRow);

  // Render tech rows + activities (view only)
  function byName(a,b){ return a.name.localeCompare(b.name); }
  const techRowMap = {};

  function render() {
    const red=[], blue=[], none=[];
    techs.filter(t=>t.active).forEach(t=>{
      if (t.team==='Red') red.push(t);
      else if (t.team==='Blue') blue.push(t);
      else none.push(t);
    });
    const ordered=[...red.sort(byName), ...blue.sort(byName), ...none.sort(byName)];

    ordered.forEach(({id,name,team})=>{
      const tr=document.createElement('tr');
      const nameCell=document.createElement('td');
      nameCell.className='employee-name';
      nameCell.classList.add(team==='Red'?'red-team':team==='Blue'?'blue-team':'no-team');
      nameCell.textContent=name;
      nameCell.dataset.techName=name;
      nameCell.dataset.techId=id;
      tr.appendChild(nameCell);

      dates.forEach(d=>{
        const td=document.createElement('td');
        td.className='day';
        if (d.getDay()===0||d.getDay()===6) td.classList.add('weekend');
        td.dataset.date=d.toISOString().split('T')[0];
        tr.appendChild(td);
      });

      body.appendChild(tr);

      // spacer after each tech
      const sr=document.createElement('tr');
      sr.className='spacer-row';
      const snc=document.createElement('td');
      snc.className='employee-name';
      sr.appendChild(snc);
      dates.forEach(()=>sr.appendChild(document.createElement('td')));
      body.appendChild(sr);

      techRowMap[name]=tr;
    });

    // paint activities
    activities.forEach(({ tech, start_date, end_date, status, type, location, project_name, notes })=>{
      const s=parseLocalDate(start_date), e=parseLocalDate(end_date);
      const row=techRowMap[tech];
      if (!row) return;
      const cells=row.querySelectorAll('td.day');

      dates.forEach((d,i)=>{
        if (d>=s && d<=e) {
          const cell=cells[i];
          cell.classList.remove('weekend');
          const color =
            ["Training"].includes(status) ? "#4EA72E" :
            ["Public Holiday","Other"].includes(status) ? "#E49EDD" :
            ["Traveling"].includes(status) ? "#FC9D9D" :
            ["Weekend Off (Sat–Sun)","Sunday Off (Sun)","Paid Time Off (PTO)","Flexible Time Off (FTO)","Rotation Off-Duty (14x14)","Rotation Off-Duty (21x21)","Weekend On-Call (Sat–Sun)"].includes(status) ? "#FFFF00" :
            ["Weekday Shift (Mon–Fri)","Regular Shift (Mon–Sat)","Rotation On-Duty (14x14)","Rotation On-Duty (21x21)","Standby"].includes(status) ? "#94DCF8" :
            "gray";
          cell.style.backgroundColor=color;
          cell.textContent = project_name || '';
          cell.title = `Status: ${status}\nType: ${type}\nLocation: ${location}\nProject: ${project_name}\nNotes: ${notes}`;
        }
      });
    });
  }

  // Simple local-only date-range modal wiring
  function wireRangeModal() {
    const modal = document.getElementById('rangeModal');
    const openBtn = document.getElementById('openRange');
    const cancelBtn = document.getElementById('cancelRange');
    const saveBtn = document.getElementById('saveRange');
    const startInput = document.getElementById('rangeStart');
    const endInput = document.getElementById('rangeEnd');

    // Pre-fill from localStorage or current defaults
    startInput.value = (localStorage.getItem('calendarStart') || '2025-05-15');
    endInput.value   = (localStorage.getItem('calendarEnd')   || '2025-12-31');

    openBtn.onclick = () => { modal.style.display = 'block'; };
    cancelBtn.onclick = () => { modal.style.display = 'none'; };
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.style.display = 'none';
    });

    saveBtn.onclick = () => {
      const s = startInput.value;
      const e = endInput.value;
      if (!s || !e) { alert('Please select both start and end dates.'); return; }
      if (new Date(s) >= new Date(e)) { alert('Start date must be before end date.'); return; }
      localStorage.setItem('calendarStart', s);
      localStorage.setItem('calendarEnd', e);
      location.reload();
    };
  }

  // Scroll to ~two weeks ago on load
  window.onload = () => {
    setTimeout(() => {
      const twoWeeksAgo = new Date();
      twoWeeksAgo.setDate(twoWeeksAgo.getDate() - 14);
      const iso = twoWeeksAgo.toISOString().split('T')[0];
      const target = document.querySelector(`td[data-date="${iso}"]`);
      if (target) {
        document.querySelector('.calendar-container').scrollLeft = target.offsetLeft - 160;
      }
    }, 300);
  };
</script>

</body>
</html>
