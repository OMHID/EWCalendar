<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Set or Reset Password</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container" style="max-width:420px; margin:80px auto; text-align:center;">
    <h2>Set Your Password</h2>
    <p>Enter your email and a temporary password below: temp1234</p>

    <input id="email" type="email" placeholder="Email address"
           style="width:100%; padding:10px; margin-top:10px;" />
    <input id="password" type="password" placeholder="New password"
           style="width:100%; padding:10px; margin-top:10px;" />
    <button id="set-password"
            style="width:100%; margin-top:15px; padding:10px; background:#0b3d91; color:#fff; border:none; border-radius:5px;">
      Set Password
    </button>

    <p id="message" style="margin-top:15px;"></p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://gxornxzzkmrkrenaszoq.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd4b3JueHp6a21ya3JlbmFzem9xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYxMjM2NjIsImV4cCI6MjA2MTY5OTY2Mn0.-fc15M3MznSnEGW9CnD2gZZe7L0Vsd9vag_W-0lCPeA";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const msgEl = document.getElementById("message");

    async function redirectByWhitelist(email) {
      try {
        const [mgrRes, techRes] = await Promise.all([
          supabase.from("manager_whitelist").select("id").eq("email", email),
          supabase.from("technician_whitelist").select("id").eq("email", email),
        ]);

        const isManager = mgrRes.data?.length > 0;
        const isTech = techRes.data?.length > 0;

        if (isManager) window.location.href = "/admin-v236.html";
        else if (isTech) window.location.href = "/";
        else {
          msgEl.textContent = "Your account is not whitelisted. Contact support.";
          msgEl.style.color = "red";
          await supabase.auth.signOut();
        }
      } catch (e) {
        msgEl.textContent = "Error determining access. Please try again.";
        msgEl.style.color = "red";
      }
    }

    document.getElementById("set-password").onclick = async () => {
      const email = document.getElementById("email").value.trim();
      const newPassword = document.getElementById("password").value.trim();

      if (!email || !newPassword) {
        msgEl.textContent = "Please fill in both fields.";
        msgEl.style.color = "red";
        return;
      }

      msgEl.textContent = "Signing in...";
      msgEl.style.color = "gray";

      // First try to sign in with the TEMP password (same as admin set)
      const { data: loginData, error: loginError } = await supabase.auth.signInWithPassword({
        email,
        password: newPassword, // try their new password in case admin gave same one
      });

      if (loginError) {
        msgEl.textContent = "Login failed with that password. Please enter the TEMP password first.";
        msgEl.style.color = "red";
        return;
      }

      msgEl.textContent = "Updating password...";
      msgEl.style.color = "gray";

      // Now update to the new password (they typed)
      const { error: updateError } = await supabase.auth.updateUser({ password: newPassword });
      if (updateError) {
        msgEl.textContent = "Error updating password: " + updateError.message;
        msgEl.style.color = "red";
        return;
      }

      msgEl.textContent = "Password updated successfully! Redirecting...";
      msgEl.style.color = "green";

      const { data: { user } } = await supabase.auth.getUser();
      setTimeout(() => redirectByWhitelist(user.email), 1000);
    };
  </script>
</body>
</html>
