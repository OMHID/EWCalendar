<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Teams</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }
    h2 {
      margin-bottom: 20px;
    }
    .teams-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
    }
    .team-column {
      border: 1px solid #ccc;
      width: 200px;
      min-height: 400px;
      padding: 10px;
      overflow-y: auto;
    }
    .team-column h3 {
      margin-top: 0;
    }
    .tech-name {
      padding: 5px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    .tech-name.selected {
      background-color: #ddd;
    }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .controls button {
      padding: 5px 10px;
      font-size: 14px;
      cursor: pointer;
    }
    .save-button {
      margin-top: 30px;
      padding: 10px 20px;
      font-size: 16px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
<h2>Manage Teams</h2>
<div class="teams-container">
  <div class="team-column" id="redTeam">
    <h3>Red Team</h3>
  </div>

  <div class="controls">
    <button onclick="moveToTeam('toRed')">To Red</button>
    <button onclick="moveToTeam('fromRed')">To No Team</button>
  </div>

  <div class="team-column" id="noTeam">
    <h3>No Team</h3>
  </div>

  <div class="controls">
    <button onclick="moveToTeam('toBlue')">To Blue</button>
    <button onclick="moveToTeam('fromBlue')">To No Team</button>
  </div>

  <div class="team-column" id="blueTeam">
    <h3>Blue Team</h3>
  </div>
</div>

<button class="save-button" onclick="saveAndReturn()">Save Changes</button>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
  const client = supabase.createClient(
    'https://gxornxzzkmrkrenaszoq.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd4b3JueHp6a21ya3JlbmFzem9xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYxMjM2NjIsImV4cCI6MjA2MTY5OTY2Mn0.-fc15M3MznSnEGW9CnD2gZZe7L0Vsd9vag_W-0lCPeA'
  );

let selectedTech = null;
let selectedDiv = null;

const redTeam = document.getElementById('redTeam');
const noTeam = document.getElementById('noTeam');
const blueTeam = document.getElementById('blueTeam');

let techs = [];

function createTechDiv(name) {
  const div = document.createElement('div');
  div.className = 'tech-name';
  div.textContent = name;
  div.onclick = () => {
    document.querySelectorAll('.tech-name').forEach(el => el.classList.remove('selected'));
    div.classList.add('selected');
    selectedTech = name;
    selectedDiv = div;
  };
  return div;
}
async function loadTechs() {
  const { data, error } = await client
    .from('techs')
    .select('*')
    .eq('active', true)
    .order('name');

  if (error) {
    console.error('Failed to load techs:', error);
    return [];
  }

  return data;
}
function populateTeams() {
  const red = [], blue = [], none = [];
  techs.forEach(t => {
    const name = t.name;
    const assigned = t.team;
    if (assigned === 'Red') red.push(name);
    else if (assigned === 'Blue') blue.push(name);
    else none.push(name);
  });
  [red, blue, none].forEach(arr => arr.sort());
  redTeam.innerHTML = '<h3>Red Team</h3>';
  blueTeam.innerHTML = '<h3>Blue Team</h3>';
  noTeam.innerHTML = '<h3>No Team</h3>';
  red.forEach(n => redTeam.appendChild(createTechDiv(n)));
  blue.forEach(n => blueTeam.appendChild(createTechDiv(n)));
  none.forEach(n => noTeam.appendChild(createTechDiv(n)));
}

function moveToTeam(action) {
  if (!selectedTech || !selectedDiv) return;

  const origin = selectedDiv.parentElement.id;
  const tech = techs.find(t => t.name === selectedTech);
  if (!tech) return;

  if (action === 'toRed') {
    tech.team = 'Red';
  } else if (action === 'toBlue') {
    tech.team = 'Blue';
  } else if (action === 'fromRed' && origin === 'redTeam') {
    tech.team = null;
  } else if (action === 'fromBlue' && origin === 'blueTeam') {
    tech.team = null;
  } else {
    return;
  }

  selectedTech = null;
  selectedDiv = null;
  populateTeams();
}

async function saveAndReturn() {
  const updates = techs.map(t =>
    client.from('techs').update({ team: t.team }).eq('id', t.id)
  );

  try {
    await Promise.all(updates);
    window.location.href = 'index.html';
  } catch (error) {
    alert('Failed to save team changes.');
    console.error(error);
  }
}

  // Also clear team assignment for techs that had a team before but were moved to "No Team"
  techs.forEach(t => {
    if (!teams[t.name] && t.team) {
      updates.push(client.from('techs').update({ team: null }).eq('id', t.id));
    }
  });

  try {
    await Promise.all(updates);
    window.location.href = 'index.html';
  } catch (error) {
    alert('Failed to save team changes.');
    console.error(error);
  }
}

(async () => {
  techs = await loadTechs();
  populateTeams();
})();
</script>
</body>
</html>
